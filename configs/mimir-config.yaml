# Mimir Monolithic Mode Configuration
target: all,alertmanager,ruler

# Multitenant configuration - set to false for simple local setups
multitenancy_enabled: false

server:
  http_listen_port: 9009
  grpc_listen_port: 9095
  log_level: info

# Common storage block to avoid repeating S3 settings
common:
  storage:
    backend: s3
    s3:
      endpoint: ${S3_ENDPOINT}
      access_key_id: ${S3_ACCESS_KEY}
      secret_access_key: ${S3_SECRET_KEY}
      bucket_name: mimir
      insecure: true

# Ingester handles incoming samples and writes them to the Write-Ahead Log (WAL)
ingester:
  ring:
    kvstore:
      store: inmemory
    replication_factor: 1

# Blocks storage defines how long-term data is handled
blocks_storage:
  backend: s3
  tsdb:
    dir: /data/tsdb
    ship_interval: 1m
  bucket_store:
    sync_interval: 5m

# Compactor deduplicates and optimizes blocks in S3
compactor:
  data_dir: /data/compactor
  compaction_interval: 30m
  cleanup_interval: 15m

# Ruler evaluates alerting and recording rules
ruler:
  enable_api: true
  rule_path: /data/ruler-workdir
  alertmanager_url: http://localhost:9009/alertmanager

# Ruler storage is now a top-level block
ruler_storage:
  backend: local
  local:
    directory: /etc/mimir/rules

# Alertmanager handles notification routing
alertmanager:
  data_dir: /data/alertmanager
  fallback_config_file: /etc/mimir/alertmanager.yaml
  external_url: http://localhost:9009/alertmanager

# Alertmanager storage must use a different bucket than blocks_storage
alertmanager_storage:
  backend: s3
  s3:
    endpoint: ${S3_ENDPOINT}
    access_key_id: ${S3_ACCESS_KEY}
    secret_access_key: ${S3_SECRET_KEY}
    bucket_name: mimir-alertmanager
    insecure: true

# Frontend scales the query performance
frontend:
  log_queries_longer_than: 5s

# Limits config prevents a single app from crashing the service
limits:
  ingestion_rate: 10000
  max_label_names_per_series: 30
  max_global_series_per_user: 100000
  # Retention - compactor enforces these
  compactor_blocks_retention_period: 30d